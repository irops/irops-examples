{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Environment-VPC-18 Template. This creates the Environment VPC within an Environment Account. Multiple Environments can co-exist. This 'VPC-18' variant uses a (/16) network for up 4 environments, with each environment in a separate (/18) VPC, and each environment containing up to 16 (/24) tier subnets replicated across up to 4 AZs.",

  "Metadata" : {
    "AWS::CloudFormation::Interface" : {
      "ParameterGroups" : [
        {
          "Label" : { "default" : "VPC Configuration" },
          "Parameters" : [ "EnvironmentVPCNetwork" ]
        },
        {
          "Label" : { "default" : "Resource Identification & Tagging" },
          "Parameters" : [ "EnvironmentName" ]
        }
      ],

      "ParameterLabels" : {
        "EnvironmentVPCNetwork" : { "default" : "Environment VPC Network" },
        "EnvironmentName" : { "default" : "Environment Name" }
      }
    }
  },

  "Parameters" : {
    "EnvironmentVPCNetwork" : {
      "Description" : "Second Octet of the Environment VPC Network: X, where VPC CIDR = 10.X.Y.0/18",
      "Type" : "Number",
      "MinValue" : "0",
      "MaxValue" : "255",
      "Default" : "80",
      "ConstraintDescription" : "must be a number from 0 to 255."
    },

    "EnvironmentName" : {
      "Description" : "Name of the Environment associated with Resources created by this Stack.",
      "Type" : "String",
      "Default" : "Production",
      "AllowedValues" : [ "Production", "Staging", "QA", "Development" ],
      "ConstraintDescription" : "must be one of the following: Production, Staging, QA, Development."
    }
  },

  "Mappings" : {
    "EnvironmentMap" : {
      "VPC"  : { "Production" : "PVPC",  "Staging" : "SVPC",  "QA" : "QVPC",  "Development" : "DVPC"  },
      "Usr1" : { "Production" : "PUsr1", "Staging" : "SUsr1", "QA" : "QUsr1", "Development" : "DUsr1" },
      "Pub1" : { "Production" : "PPub1", "Staging" : "SPub1", "QA" : "QPub1", "Development" : "DPub1" },
      "Web1" : { "Production" : "PWeb1", "Staging" : "SWeb1", "QA" : "QWeb1", "Development" : "DWeb1" },
      "Web2" : { "Production" : "PWeb2", "Staging" : "SWeb2", "QA" : "QWeb2", "Development" : "DWeb2" },
      "App1" : { "Production" : "PApp1", "Staging" : "SApp1", "QA" : "QApp1", "Development" : "DApp1" },
      "App2" : { "Production" : "PApp2", "Staging" : "SApp2", "QA" : "QApp2", "Development" : "DApp2" },
      "App3" : { "Production" : "PApp3", "Staging" : "SApp3", "QA" : "QApp3", "Development" : "DApp3" },
      "App4" : { "Production" : "PApp4", "Staging" : "SApp4", "QA" : "QApp4", "Development" : "DApp4" },
      "Dat1" : { "Production" : "PDat1", "Staging" : "SDat1", "QA" : "QDat1", "Development" : "DDat1" },
      "Dat2" : { "Production" : "PDat2", "Staging" : "SDat2", "QA" : "QDat2", "Development" : "DDat2" },
      "Dat3" : { "Production" : "PDat3", "Staging" : "SDat3", "QA" : "QDat3", "Development" : "DDat3" },
      "Dat4" : { "Production" : "PDat4", "Staging" : "SDat4", "QA" : "QDat4", "Development" : "DDat4" },
      "Que1" : { "Production" : "PQue1", "Staging" : "SQue1", "QA" : "QQue1", "Development" : "DQue1" },
      "Que2" : { "Production" : "PQue2", "Staging" : "SQue1", "QA" : "QQue2", "Development" : "DQue1" },
      "Bld1" : { "Production" : "PBld1", "Staging" : "SBld1", "QA" : "QBld1", "Development" : "DBld1" },
      "Mgt1" : { "Production" : "PMgt1", "Staging" : "SMgt1", "QA" : "QMgt1", "Development" : "DMgt1" }
    },

    "SubnetMap" : {
      "PVPC"  : { "Region" : "0.0/18" },
      "PUsr1" : { "ZoneA" :   "0.0/24", "ZoneB" :  "16.0/24", "ZoneC" :  "32.0/24", "ZoneD" :  "48.0/24" },
      "PPub1" : { "ZoneA" :   "1.0/24", "ZoneB" :  "17.0/24", "ZoneC" :  "33.0/24", "ZoneD" :  "49.0/24" },
      "PWeb1" : { "ZoneA" :   "2.0/24", "ZoneB" :  "18.0/24", "ZoneC" :  "34.0/24", "ZoneD" :  "50.0/24" },
      "PWeb2" : { "ZoneA" :   "3.0/24", "ZoneB" :  "19.0/24", "ZoneC" :  "35.0/24", "ZoneD" :  "51.0/24" },
      "PApp1" : { "ZoneA" :   "4.0/24", "ZoneB" :  "20.0/24", "ZoneC" :  "36.0/24", "ZoneD" :  "52.0/24" },
      "PApp2" : { "ZoneA" :   "5.0/24", "ZoneB" :  "21.0/24", "ZoneC" :  "37.0/24", "ZoneD" :  "53.0/24" },
      "PApp3" : { "ZoneA" :   "6.0/24", "ZoneB" :  "22.0/24", "ZoneC" :  "38.0/24", "ZoneD" :  "54.0/24" },
      "PApp4" : { "ZoneA" :   "7.0/24", "ZoneB" :  "23.0/24", "ZoneC" :  "39.0/24", "ZoneD" :  "55.0/24" },
      "PDat1" : { "ZoneA" :   "8.0/24", "ZoneB" :  "24.0/24", "ZoneC" :  "40.0/24", "ZoneD" :  "56.0/24" },
      "PDat2" : { "ZoneA" :   "9.0/24", "ZoneB" :  "25.0/24", "ZoneC" :  "41.0/24", "ZoneD" :  "57.0/24" },
      "PDat3" : { "ZoneA" :  "10.0/24", "ZoneB" :  "26.0/24", "ZoneC" :  "42.0/24", "ZoneD" :  "58.0/24" },
      "PDat4" : { "ZoneA" :  "11.0/24", "ZoneB" :  "27.0/24", "ZoneC" :  "43.0/24", "ZoneD" :  "59.0/24" },
      "PQue1" : { "ZoneA" :  "12.0/24", "ZoneB" :  "28.0/24", "ZoneC" :  "44.0/24", "ZoneD" :  "60.0/24" },
      "PQue2" : { "ZoneA" :  "13.0/24", "ZoneB" :  "29.0/24", "ZoneC" :  "45.0/24", "ZoneD" :  "61.0/24" },
      "PBld1" : { "ZoneA" :  "14.0/24", "ZoneB" :  "30.0/24", "ZoneC" :  "46.0/24", "ZoneD" :  "62.0/24" },
      "PMgt1" : { "ZoneA" :  "15.0/24", "ZoneB" :  "31.0/24", "ZoneC" :  "47.0/24", "ZoneD" :  "63.0/24" },
      "SVPC"  : { "Region" : "64.0/18" },
      "SUsr1" : { "ZoneA" :  "64.0/24", "ZoneB" :  "80.0/24", "ZoneC" :  "96.0/24", "ZoneD" : "112.0/24" },
      "SPub1" : { "ZoneA" :  "65.0/24", "ZoneB" :  "81.0/24", "ZoneC" :  "97.0/24", "ZoneD" : "113.0/24" },
      "SWeb1" : { "ZoneA" :  "66.0/24", "ZoneB" :  "82.0/24", "ZoneC" :  "98.0/24", "ZoneD" : "114.0/24" },
      "SWeb2" : { "ZoneA" :  "67.0/24", "ZoneB" :  "83.0/24", "ZoneC" :  "99.0/24", "ZoneD" : "115.0/24" },
      "SApp1" : { "ZoneA" :  "68.0/24", "ZoneB" :  "84.0/24", "ZoneC" : "100.0/24", "ZoneD" : "116.0/24" },
      "SApp2" : { "ZoneA" :  "69.0/24", "ZoneB" :  "85.0/24", "ZoneC" : "101.0/24", "ZoneD" : "117.0/24" },
      "SApp3" : { "ZoneA" :  "70.0/24", "ZoneB" :  "86.0/24", "ZoneC" : "102.0/24", "ZoneD" : "118.0/24" },
      "SApp4" : { "ZoneA" :  "71.0/24", "ZoneB" :  "87.0/24", "ZoneC" : "103.0/24", "ZoneD" : "119.0/24" },
      "SDat1" : { "ZoneA" :  "72.0/24", "ZoneB" :  "88.0/24", "ZoneC" : "104.0/24", "ZoneD" : "120.0/24" },
      "SDat2" : { "ZoneA" :  "73.0/24", "ZoneB" :  "89.0/24", "ZoneC" : "105.0/24", "ZoneD" : "121.0/24" },
      "SDat3" : { "ZoneA" :  "74.0/24", "ZoneB" :  "90.0/24", "ZoneC" : "106.0/24", "ZoneD" : "122.0/24" },
      "SDat4" : { "ZoneA" :  "75.0/24", "ZoneB" :  "91.0/24", "ZoneC" : "107.0/24", "ZoneD" : "123.0/24" },
      "SQue1" : { "ZoneA" :  "76.0/24", "ZoneB" :  "92.0/24", "ZoneC" : "108.0/24", "ZoneD" : "124.0/24" },
      "SQue2" : { "ZoneA" :  "77.0/24", "ZoneB" :  "93.0/24", "ZoneC" : "109.0/24", "ZoneD" : "125.0/24" },
      "SBld1" : { "ZoneA" :  "78.0/24", "ZoneB" :  "94.0/24", "ZoneC" : "110.0/24", "ZoneD" : "126.0/24" },
      "SMgt1" : { "ZoneA" :  "79.0/24", "ZoneB" :  "95.0/24", "ZoneC" : "111.0/24", "ZoneD" : "127.0/24" },
      "QVPC"  : { "Region" : "128.0/18" },
      "QUsr1" : { "ZoneA" : "128.0/24", "ZoneB" : "144.0/24", "ZoneC" : "160.0/24", "ZoneD" : "176.0/24" },
      "QPub1" : { "ZoneA" : "129.0/24", "ZoneB" : "145.0/24", "ZoneC" : "161.0/24", "ZoneD" : "177.0/24" },
      "QWeb1" : { "ZoneA" : "130.0/24", "ZoneB" : "146.0/24", "ZoneC" : "162.0/24", "ZoneD" : "178.0/24" },
      "QWeb2" : { "ZoneA" : "131.0/24", "ZoneB" : "147.0/24", "ZoneC" : "163.0/24", "ZoneD" : "179.0/24" },
      "QApp1" : { "ZoneA" : "132.0/24", "ZoneB" : "148.0/24", "ZoneC" : "164.0/24", "ZoneD" : "180.0/24" },
      "QApp2" : { "ZoneA" : "133.0/24", "ZoneB" : "149.0/24", "ZoneC" : "165.0/24", "ZoneD" : "181.0/24" },
      "QApp3" : { "ZoneA" : "134.0/24", "ZoneB" : "150.0/24", "ZoneC" : "166.0/24", "ZoneD" : "182.0/24" },
      "QApp4" : { "ZoneA" : "135.0/24", "ZoneB" : "151.0/24", "ZoneC" : "167.0/24", "ZoneD" : "183.0/24" },
      "QDat1" : { "ZoneA" : "136.0/24", "ZoneB" : "152.0/24", "ZoneC" : "168.0/24", "ZoneD" : "184.0/24" },
      "QDat2" : { "ZoneA" : "137.0/24", "ZoneB" : "153.0/24", "ZoneC" : "169.0/24", "ZoneD" : "185.0/24" },
      "QDat3" : { "ZoneA" : "138.0/24", "ZoneB" : "154.0/24", "ZoneC" : "170.0/24", "ZoneD" : "186.0/24" },
      "QDat4" : { "ZoneA" : "139.0/24", "ZoneB" : "155.0/24", "ZoneC" : "171.0/24", "ZoneD" : "187.0/24" },
      "QQue1" : { "ZoneA" : "140.0/24", "ZoneB" : "156.0/24", "ZoneC" : "172.0/24", "ZoneD" : "188.0/24" },
      "QQue2" : { "ZoneA" : "141.0/24", "ZoneB" : "157.0/24", "ZoneC" : "173.0/24", "ZoneD" : "189.0/24" },
      "QBld1" : { "ZoneA" : "142.0/24", "ZoneB" : "158.0/24", "ZoneC" : "174.0/24", "ZoneD" : "190.0/24" },
      "QMgt1" : { "ZoneA" : "143.0/24", "ZoneB" : "159.0/24", "ZoneC" : "175.0/24", "ZoneD" : "191.0/24" },
      "DVPC"  : { "Region" : "192.0/18" },
      "DUsr1" : { "ZoneA" : "192.0/24", "ZoneB" : "208.0/24", "ZoneC" : "224.0/24", "ZoneD" : "240.0/24" },
      "DPub1" : { "ZoneA" : "193.0/24", "ZoneB" : "209.0/24", "ZoneC" : "225.0/24", "ZoneD" : "241.0/24" },
      "DWeb1" : { "ZoneA" : "194.0/24", "ZoneB" : "210.0/24", "ZoneC" : "226.0/24", "ZoneD" : "242.0/24" },
      "DWeb2" : { "ZoneA" : "195.0/24", "ZoneB" : "211.0/24", "ZoneC" : "227.0/24", "ZoneD" : "243.0/24" },
      "DApp1" : { "ZoneA" : "196.0/24", "ZoneB" : "212.0/24", "ZoneC" : "228.0/24", "ZoneD" : "244.0/24" },
      "DApp2" : { "ZoneA" : "197.0/24", "ZoneB" : "213.0/24", "ZoneC" : "229.0/24", "ZoneD" : "245.0/24" },
      "DApp3" : { "ZoneA" : "198.0/24", "ZoneB" : "214.0/24", "ZoneC" : "230.0/24", "ZoneD" : "246.0/24" },
      "DApp4" : { "ZoneA" : "199.0/24", "ZoneB" : "215.0/24", "ZoneC" : "231.0/24", "ZoneD" : "247.0/24" },
      "DDat1" : { "ZoneA" : "200.0/24", "ZoneB" : "216.0/24", "ZoneC" : "232.0/24", "ZoneD" : "248.0/24" },
      "DDat2" : { "ZoneA" : "201.0/24", "ZoneB" : "217.0/24", "ZoneC" : "233.0/24", "ZoneD" : "249.0/24" },
      "DDat3" : { "ZoneA" : "202.0/24", "ZoneB" : "218.0/24", "ZoneC" : "234.0/24", "ZoneD" : "250.0/24" },
      "DDat4" : { "ZoneA" : "203.0/24", "ZoneB" : "219.0/24", "ZoneC" : "235.0/24", "ZoneD" : "251.0/24" },
      "DQue1" : { "ZoneA" : "204.0/24", "ZoneB" : "220.0/24", "ZoneC" : "236.0/24", "ZoneD" : "252.0/24" },
      "DQue2" : { "ZoneA" : "205.0/24", "ZoneB" : "221.0/24", "ZoneC" : "237.0/24", "ZoneD" : "253.0/24" },
      "DBld1" : { "ZoneA" : "206.0/24", "ZoneB" : "222.0/24", "ZoneC" : "238.0/24", "ZoneD" : "254.0/24" },
      "DMgt1" : { "ZoneA" : "207.0/24", "ZoneB" : "223.0/24", "ZoneC" : "239.0/24", "ZoneD" : "255.0/24" }
    }
  },

  "Conditions" : {
    "CreateProductionResources" : { "Fn::Equals" : [ { "Ref" : "EnvironmentName" }, "Production" ] }
  },

  "Resources" : {
    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "EnableDnsSupport" : "true",
        "EnableDnsHostnames" : "true",
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "VPC", { "Ref" : "EnvironmentName" } ]}, "Region" ]} ]]},
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-VPC" } }
        ]
      }
    },

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-InternetGateway" } }
        ]
      }
    },

    "InternetGatewayAttachment" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "Properties" : {
         "VpcId" : { "Ref" : "VPC" },
         "InternetGatewayId" : { "Ref" : "InternetGateway" }
       }
    },

    "Pub1SubnetA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "Pub1", { "Ref" : "EnvironmentName" } ]}, "ZoneA" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "true",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-Pub1SubnetA" } }
        ]
      }
    },

    "Pub1SubnetB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "Pub1", { "Ref" : "EnvironmentName" } ]}, "ZoneB" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "true",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-Pub1SubnetB" } }
        ]
      }
    },

    "Web1SubnetA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "Web1", { "Ref" : "EnvironmentName" } ]}, "ZoneA" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "true",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-Web1SubnetA" } }
        ]
      }
    },

    "Web1SubnetB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "Web1", { "Ref" : "EnvironmentName" } ]}, "ZoneB" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "true",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-Web1SubnetB" } }
        ]
      }
    },

    "App1SubnetA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "App1", { "Ref" : "EnvironmentName" } ]}, "ZoneA" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "false",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-App1SubnetA" } }
        ]
      }
    },

    "App1SubnetB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "App1", { "Ref" : "EnvironmentName" } ]}, "ZoneB" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "false",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-App1SubnetB" } }
        ]
      }
    },

    "Dat1SubnetA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "Dat1", { "Ref" : "EnvironmentName" } ]}, "ZoneA" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "false",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-Dat1SubnetA" } }
        ]
      }
    },

    "Dat1SubnetB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "Dat1", { "Ref" : "EnvironmentName" } ]}, "ZoneB" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "false",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-Dat1SubnetB" } }
        ]
      }
    },

    "Que1SubnetA" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "Que1", { "Ref" : "EnvironmentName" } ]}, "ZoneA" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "false",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-Que1SubnetA" } }
        ]
      }
    },

    "Que1SubnetB" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::Join" : [ ".", [ "10", { "Ref" : "EnvironmentVPCNetwork" }, { "Fn::FindInMap" : [ "SubnetMap", { "Fn::FindInMap" : [ "EnvironmentMap", "Que1", { "Ref" : "EnvironmentName" } ]}, "ZoneB" ]} ]]},
        "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] },
        "MapPublicIpOnLaunch" : "false",
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-Que1SubnetB" } }
        ]
      }
    },

    "PublicRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-PublicRouteTable" } }
        ]
      }
    },

    "PublicDefaultRoute" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "InternetGatewayAttachment",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PublicRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" }
      }
    },

    "Pub1SubnetARouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "Pub1SubnetA" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },

    "Pub1SubnetBRouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "Pub1SubnetB" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },

    "Web1SubnetARouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "Web1SubnetA" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },

    "Web1SubnetBRouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "Web1SubnetB" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },

    "NatGatewayAEIP" : {
      "Type" : "AWS::EC2::EIP",
      "DependsOn" : "InternetGatewayAttachment",
      "Properties" : {
        "Domain" : "vpc"
      }
    },

    "NatGatewayBEIP" : {
      "Type" : "AWS::EC2::EIP",
      "DependsOn" : "InternetGatewayAttachment",
      "Condition" : "CreateProductionResources",
      "Properties" : {
        "Domain" : "vpc"
      }
    },

    "NatGatewayA" : {
      "Type" : "AWS::EC2::NatGateway",
      "Properties" : {
        "AllocationId" : { "Fn::GetAtt" : [ "NatGatewayAEIP", "AllocationId" ] },
        "SubnetId" : { "Ref" : "Pub1SubnetA" }
      }
    },

    "NatGatewayB" : {
      "Type" : "AWS::EC2::NatGateway",
      "Condition" : "CreateProductionResources",
      "Properties" : {
        "AllocationId" : { "Fn::GetAtt" : [ "NatGatewayBEIP", "AllocationId" ] },
        "SubnetId" : { "Ref" : "Pub1SubnetB" }
      }
    },

    "PrivateRouteTableA" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-PrivateRouteTableA" } }
        ]
      }
    },

    "PrivateDefaultRouteA" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTableA" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "NatGatewayId" : { "Ref" : "NatGatewayA" }
      }
    },

    "App1SubnetARouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTableA" },
        "SubnetId" : { "Ref" : "App1SubnetA" }
      }
    },

    "Dat1SubnetARouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTableA" },
        "SubnetId" : { "Ref" : "Dat1SubnetA" }
      }
    },

    "Que1SubnetARouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTableA" },
        "SubnetId" : { "Ref" : "Que1SubnetA" }
      }
    },

    "PrivateRouteTableB" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Name", "Value" : { "Fn::Sub" : "${EnvironmentName}-PrivateRouteTableB" } }
        ]
      }
    },

    "PrivateDefaultRouteB" : {
      "Type" : "AWS::EC2::Route",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTableB" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "NatGatewayId" : { "Fn::If" : [ "CreateProductionResources", { "Ref" : "NatGatewayB" }, { "Ref" : "NatGatewayA" } ] }
      }
    },

    "App1SubnetBRouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTableB" },
        "SubnetId" : { "Ref" : "App1SubnetB" }
      }
    },

    "Dat1SubnetBRouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTableB" },
        "SubnetId" : { "Ref" : "Dat1SubnetB" }
      }
    },

    "Que1SubnetBRouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTableB" },
        "SubnetId" : { "Ref" : "Que1SubnetB" }
      }
    }
  },

  "Outputs" : {
    "VPC" : {
      "Description" : "The VPC",
      "Value" :  { "Ref" : "VPC" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-VPC" } }
    },

    "Pub1SubnetA" : {
      "Description" : "The Public Subnet in Availability Zone A",
      "Value" :  { "Ref" : "Pub1SubnetA" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-Pub1SubnetA" }}
    },

    "Pub1SubnetB" : {
      "Description" : "The Public Subnet in Availability Zone B",
      "Value" :  { "Ref" : "Pub1SubnetB" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-Pub1SubnetB" }}
    },

    "Web1SubnetA" : {
      "Description" : "The Web Subnet in Availability Zone A",
      "Value" :  { "Ref" : "Web1SubnetA" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-Web1SubnetA" }}
    },

    "Web1SubnetB" : {
      "Description" : "The Web Subnet in Availability Zone B",
      "Value" :  { "Ref" : "Web1SubnetB" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-Web1SubnetB" }}
    },

    "App1SubnetA" : {
      "Description" : "The Application Subnet in Availability Zone A",
      "Value" :  { "Ref" : "App1SubnetA" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-App1SubnetA" }}
    },

    "App1SubnetB" : {
      "Description" : "The Application Subnet in Availability Zone B",
      "Value" :  { "Ref" : "App1SubnetB" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-App1SubnetB" }}
    },

    "Dat1SubnetA" : {
      "Description" : "The Database Subnet in Availability Zone A",
      "Value" :  { "Ref" : "Dat1SubnetA" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-Dat1SubnetA" }}
    },

    "Dat1SubnetB" : {
      "Description" : "The Database Subnet in Availability Zone B",
      "Value" :  { "Ref" : "Dat1SubnetB" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-Dat1SubnetB" }}
    },

    "Que1SubnetA" : {
      "Description" : "The Message Subnet in Availability Zone A",
      "Value" :  { "Ref" : "Que1SubnetA" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-Que1SubnetA" }}
    },

    "Que1SubnetB" : {
      "Description" : "The Message Subnet in Availability Zone B",
      "Value" :  { "Ref" : "Que1SubnetB" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-Que1SubnetB" }}
    }
  }
}
